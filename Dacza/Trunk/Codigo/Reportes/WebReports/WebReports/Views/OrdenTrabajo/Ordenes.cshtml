@model IEnumerable<WebReports.Models.OrdenTrabajo>
@using System.Web.Mvc.Html;
@using System.Web.Mvc;

@{
    ViewBag.Title = "Ordenes de Trabajo";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<hgroup class="title">
    <h1 class="text-center">@ViewBag.Title</h1>
    <p />
</hgroup>

 <div class="container">
    
        @{
            WebReports.Models.FilterModels.FilterOrdenTrabajo filtro = (WebReports.Models.FilterModels.FilterOrdenTrabajo)Session["Filtro"]; 
            String sFiltro= "";
            int nCont = 0;
            if(!filtro.Sucursal.IsEmpty())
            {
                String sucursal = Session["Sucursal"].ToString();
                nCont++;
                <div class="container-left-filter">
                    <h2>Sucursal: @sucursal</h2>
                </div>
            } 
            if(filtro.FechaIni != null && filtro.FechaFin != null)
            {
                if (nCont > 0){
                    <div class="container-right-filter">
                        <h2>Fecha: @filtro.FechaIni.Value.Date.ToShortDateString() al @filtro.FechaFin.Value.Date.ToShortDateString()</h2>
                    </div>
                }
                else{
                    <div class="container-left-filter">
                        <h2>Fecha: @filtro.FechaIni.Value.Date.ToShortDateString() al @filtro.FechaFin.Value.Date.ToShortDateString()</h2>
                    </div>
                }
                nCont++;
            } 
            else if(filtro.FechaIni != null)
            {
                if (nCont > 0){
                    <div class="container-right-filter">
                        <h2>Fecha: @filtro.FechaIni.Value.Date.ToShortDateString() al @DateTime.Today.Date.ToShortDateString()</h2>
                    </div>
                }
                else{
                    <div class="container-left-filter">
                        <h2>Fecha: @filtro.FechaIni.Value.Date.ToShortDateString() al @DateTime.Today.Date.ToShortDateString()</h2>
                    </div>
                }
                nCont++;
            }
            else if(filtro.FechaFin != null)
            {
                if (nCont > 0){
                    <div class="container-right-filter">
                        <h2>Fecha: al @filtro.FechaFin.Value.Date.ToShortDateString()</h2>
                    </div>
                }
                else{
                    <div class="container-left-filter">
                        <h2>Fecha: al @filtro.FechaFin.Value.Date.ToShortDateString()</h2>
                    </div>
                }
                nCont++;
            }                
            if (Session["Fase"] != null)
            {
                if ((nCont % 2) == 0)
                {
                    <div class="container-left-filter">
                        <h2>Fase: @Session["Fase"].ToString()</h2>
                    </div>
                }
                else if (nCont > 0)
                {
                    <div class="container-right-filter">
                        <h2>Fase: @Session["Fase"].ToString()</h2>
                    </div>
                }
                nCont++;
            }         
        
            if(!filtro.Folio.IsEmpty())
            {
                if ((nCont % 2) == 0)
                {
                    <div class="container-left-filter">
                        <h2>Folio: @filtro.Folio</h2>
                    </div>
                }
                else if (nCont > 0)
                {
                    <div class="container-right-filter">
                        <h2>Folio: @filtro.Folio</h2>
                    </div>
                }
                nCont++;
            } 
            if(!filtro.Vin.IsEmpty())
            {
                if ((nCont % 2) == 0)
                {
                    <div class="container-left-filter">
                        <h2>Vin: @filtro.Vin</h2>
                    </div>
                }
                else if (nCont > 0)
                {
                    <div class="container-right-filter">
                        <h2>Vin: @filtro.Vin</h2>
                    </div>
                }
                nCont++;
            }
            if(!filtro.Cliente.IsEmpty())
            {
                if ((nCont % 2) == 0)
                {
                    <div class="container-left-filter">
                        <h2>Cliente: @filtro.Cliente</h2>
                    </div>
                }
                else if (nCont > 0)
                {
                    <div class="container-right-filter">
                        <h2>Cliente: @filtro.Cliente</h2>
                    </div>
                }
            } 
        }     
</div>

<p></p>

 <div class="panel-group">
    @{
        String currTaller = "";
        String currAgenteCliente = "";  
        Boolean bCerrar = true;     
        
        
        foreach (var item in Model) {
            if (!currTaller.Equals("") && !currTaller.Equals(item.TallerId))
            {
                @Html.Raw("</div>")
                @Html.Raw("</div>")
                @Html.Raw("</div>")
                @Html.Raw("</div>")
                bCerrar = false;
            }
            if(!currTaller.Equals(item.TallerId)){
                currTaller = item.TallerId;
                @Html.Raw("<div class=\"panel panel-default\">")
                @Html.Raw("<div class=\"panel-heading panel-heading-top\">")
                @Html.Raw("<h4 class=\"panel-title\">")
                @Html.Raw("<a data-toggle=\"collapse\" href=#" + @item.TallerId + ">" + @item.Taller.Descripcion + "</a>")
                @Html.Raw("</h4>")
                @Html.Raw("</div>")
                @Html.Raw("<div id=" + @item.TallerId + " class=\"panel-collapse collapse\">")
                @Html.Raw("<div class=\"panel-body\">")
                @Html.Raw("<div class=\"panel-group\">")
                bCerrar = true;
            }
           
            if(!currAgenteCliente.Equals(item.AgenteId + "-" + item.ClienteId)){
                @Html.Raw("<div class=\"panel panel-default\">")
                @Html.Raw("<div class=\"panel-heading\">")
                @Html.Raw("<h4 class=\"panel-title\">")
                @Html.Raw("<a data-toggle=\"collapse\" href=#" + @item.TallerId + "-" + @item.AgenteId + "-" + @item.ClienteId +">" + @item.Usuario.Nombre  + "-" +  @item.Cliente.RazonSocial + "</a>")
                @Html.Raw("</h4>")
                @Html.Raw("</div>")
                @Html.Partial("OrdenTrabajo", Model.ToList().FindAll(x => x.TallerId == item.TallerId && x.AgenteId == item.AgenteId && x.ClienteId == item.ClienteId))
                @Html.Raw("</div>")
                currAgenteCliente = item.AgenteId + "-" + item.ClienteId;
            }
            
            
         }//foreach (var item in Model)
         
         if(bCerrar){
             @Html.Raw("</div>")
             @Html.Raw("</div>")
             @Html.Raw("</div>")
             @Html.Raw("</div>")
         }
         
     }   
         
 </div>

<label id="ordenIdActual" style="display:none"></label>

<!-- Modal Cambio de fase -->
<div class="modal fade" id="myModalFase" tabindex="-1" role="dialog" aria-labelledby="myModalLabelFase" >
    <div class="modal-dialog" role="document">
        <div class="modal-content image-window centered">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h2 class="modal-title" id="myModalLabelFase">Seleccionar Fase</h2>
            </div>
            <div class="modal-body">
                <form role="form">
                    <div class="container">
                        <div class="form-group">
                            <label for="sucursal" class="col-lg-3 control-label text-label">
                                Fase</label>
                            <div class="col-lg-0 filter-width">
                                @{
                                    List<SelectListItem> listItems2= new List<SelectListItem>();                       
                                    listItems2.Add(new SelectListItem{
                                        Text = "Cancelada",
                                        Value = "0"
                                    });
                                }
                                @Html.DropDownList("Fase", listItems2, new { @id = "ddlFase", @class = "form-control" }) 
                            </div>
                        </div> 
                    </div> 
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" onclick ="ActualizarFaseOrden()" class="btn btn-default" data-dismiss="modal">Aceptar</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script src="../Scripts/bootstrap.min.js" type="text/javascript"></script>
    <script src="../Scripts/custom.js" type="text/javascript"></script>
}
