if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[sel_AsignaComisiones]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[sel_AsignaComisiones]
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO


CREATE PROCEDURE dbo.sel_AsignaComisiones

@Opcion as int,
@IdCedis as bigint,
@IdTipoRuta as bigint,
@IdFamilia as bigint,
@IdCategoria as Varchar(5)

AS

if @Opcion = 1 		--Categorias Asignadas al Cedis x Familia (Todas)		
begin

	SELECT     	FNCOMFAM.IdCedis, FNCOMFAM.IdTipoRuta, FNCOMFAM.IdFamilia, isnull(CATCED.IdCategoria, 'SA') as IdCategoria, 0 as IdCalculoBase,
			'Tipo de Ruta: ' + FNCOMFAM.TipoRuta as [Tipo de Ruta], FNCOMFAM.Familia, 
	                      	ISNULL('Categoría: ' + CATCED.IdCategoria, 'Sin Asignar') AS Categoría, 'Kilolitros' as [Cálculo en Base a]
	FROM         	CategoriaCedis CATCED RIGHT OUTER JOIN
	                      	FN_ComisionesTipoRutaYFamilia(@IdCedis) FNCOMFAM ON CATCED.IdTipoRuta = FNCOMFAM.IdTipoRuta AND CATCED.IdCedis = FNCOMFAM.IdCedis AND 
	                      	CATCED.IdFamilia = FNCOMFAM.IdFamilia
	ORDER BY 	FNCOMFAM.IdCedis, FNCOMFAM.IdTipoRuta, FNCOMFAM.TipoRuta, FNCOMFAM.IdFamilia
		
end

if @Opcion = 2 		--Categorias Asignadas al Cedis x Familia (Solo las asignadas)		
begin

	SELECT     FNCOMFAM.IdCedis, FNCOMFAM.IdTipoRuta, FNCOMFAM.IdFamilia, ISNULL(CATCED.IdCategoria, 'SA') AS IdCategoria, 0 as IdCalculoBase,
	                      'Tipo de Ruta: ' + FNCOMFAM.TipoRuta AS [Tipo de Ruta], FNCOMFAM.Familia, ISNULL('Categoría: ' + CATCED.IdCategoria, 'Sin Asignar') 
	                      AS Categoría, 'Kilolitros' as [Cálculo en Base a]
	FROM         CategoriaCedis CATCED INNER JOIN
	                      FN_ComisionesTipoRutaYFamilia(@IdCedis) FNCOMFAM ON CATCED.IdTipoRuta = FNCOMFAM.IdTipoRuta AND CATCED.IdCedis = FNCOMFAM.IdCedis AND 
	                      CATCED.IdFamilia = FNCOMFAM.IdFamilia
	ORDER BY FNCOMFAM.IdCedis, FNCOMFAM.IdTipoRuta, FNCOMFAM.TipoRuta, FNCOMFAM.IdFamilia
		
end

if @Opcion = 3 		--Categorias Asignadas al Cedis x Familia (Solo las asignadas)		
begin

	SELECT     CATCED.IdCedis, CATCED.IdTipoRuta, CATCED.IdFamilia, CATCED.IdCategoria, 'Tipo de Ruta: ' + TPRUT.TipoRuta AS [Tipo de Ruta], FAM.Familia, 
	                      ' Categoría ' + CATCED.IdCategoria AS Categoría, CAT.Inicial AS De, CAT.Final AS A, CAT.ComisionVendedor AS [Fac.Vendedor], 
	                      CAT.ComisionAyudante AS [Fac.Ayudante]
	FROM         Categoria CAT INNER JOIN
	                      CategoriaCedis CATCED ON CAT.IdCategoria = CATCED.IdCategoria AND CAT.IdFamilia = CATCED.IdFamilia AND 
	                      CAT.IdTipoRuta = CATCED.IdTipoRuta INNER JOIN
	                      Familias FAM ON CATCED.IdFamilia = FAM.IdFamilia INNER JOIN
	                      TipoRuta TPRUT ON CATCED.IdTipoRuta = TPRUT.IdTipoRuta
	WHERE     (FAM.IdFamilia = @IdFamilia) AND (CATCED.IdCedis = @IdCedis) AND (CAT.IdTipoRuta = @IdTipoRuta)
	GROUP BY TPRUT.TipoRuta, CAT.IdTipoRuta, FAM.Familia, CATCED.IdCategoria, CAT.Inicial, CAT.Final, CAT.ComisionVendedor, CAT.ComisionAyudante, 
	                      CATCED.IdCedis, CATCED.IdTipoRuta, CATCED.IdFamilia
	ORDER BY CATCED.IdCedis, CATCED.IdTipoRuta, CATCED.IdFamilia, CATCED.IdCategoria, CAT.Inicial
		
end

if @Opcion = 10 		--Categorias 		
begin

	Select distinct IdCategoria, 'Categoría: ' + CategoriaCedis.IdCategoria AS Categoria from CategoriaCedis
		
end
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

